<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Apuntes</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

    <style>
        :root {
            background: #121212;
            color: #fff;
            font-family: Roboto, sans-serif
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            align-items: center;
            justify-content: flex-start;
            padding: 2rem;
            gap: 1.5rem
        }

        .container {
            max-width: 900px;
            width: 100%;
            text-align: center
        }

        .big-img {
            width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            background: #fff;
            padding: 0.5rem
        }

        .form-inline {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
            flex-wrap: wrap
        }

        .form-inline select {
            appearance: none;
            border-radius: 8px;
            padding: .45rem .7rem;
            background: #1e1e1e;
            color: #fff;
            border: 1px solid #333;
            min-width: 140px;
            cursor: pointer
        }

        .form-inline select:focus {
            outline: 2px solid rgba(255, 136, 0, 0.25)
        }

        .add-btn {
            background: #ff0044;
            border: none;
            color: #fff;
            font-weight: 700;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem
        }

        .add-btn:hover {
            background: #ff8800;
            color: #121212
        }

        .save-btn {
            background: #28a745;
            border: none;
            color: #fff;
            font-weight: 700;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-left: 6px
        }

        .save-btn:hover {
            opacity: 0.9
        }

        .saved-wrap {
            margin-top: 1.25rem;
            width: 100%;
            overflow: auto
        }

        table.saved {
            width: 100%;
            border-collapse: collapse;
            background: #1a1a1a;
            color: #fff;
            border-radius: 8px;
            overflow: hidden
        }

        table.saved thead {
            background: #111;
            padding: 0.5rem
        }

        table.saved th,
        table.saved td {
            padding: .6rem .75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            font-size: .95rem
        }

        table.saved tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02)
        }

        .empty-msg {
            color: #aaa;
            padding: .6rem;
            text-align: center
        }


        .volver {
            background: #ff0044;
            border: none;
            color: #fff;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Oswald', sans-serif;
            margin-bottom: 1.5rem;
            display: block;
        }

        .volver:hover {
            background: #ff8800;
        }
        
        .del-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: #ff6666;
            width: 36px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem
        }

        .del-btn:hover {
            background: rgba(255, 0, 68, 0.06)
        }
    </style>
</head>

<body>
    <div class="container">
        <button class="volver" onclick="history.back()">â¬… Volver</button>
        <h1 style="font-family:Oswald, sans-serif;letter-spacing:1px">Apuntes</h1>
        <img id="bigImage" class="big-img" src="" alt="Imagen grande">
        
        <form id="optionsForm" class="form-inline" role="form" aria-label="Formulario de selecciÃ³n"
            onsubmit="event.preventDefault()">
            <label for="seriesSelect" class="sr-only">Series</label>
            <button type="button" id="addSeriesBtn" class="add-btn" aria-label="AÃ±adir serie">+</button>
            <select id="seriesSelect" name="series" aria-label="Series">
                <option value="">NÂº Series</option>
                <option value="1">1Âº Serie</option>
                <option value="2">2Âº Serie</option>
                <option value="3">3Âº Serie</option>
                <option value="4">4Âº Serie</option>
            </select>

            <label for="option2" class="sr-only">Repeticiones</label>
            <button type="button" id="addOption2Btn" class="add-btn" aria-label="AÃ±adir repeticiones">+</button>
            <select id="option2" name="option2" aria-label="OpciÃ³n 2">
                <option value="">Selecciona Repeticiones</option>
                <option value="A">12</option>
                <option value="B">10</option>
                <option value="C">8</option>
                <option value="D">6</option>
            </select>

            <label for="option3" class="sr-only">Peso</label>
            <button type="button" id="addOption3Btn" class="add-btn" aria-label="AÃ±adir peso">+</button>
            <select id="option3" name="option3" aria-label="OpciÃ³n 3">
                <option value="">Selecciona Peso</option>
                <option value="1">5</option>
                <option value="2">10</option>
                <option value="3">15</option>
            </select>
            
            <button type="button" id="saveBtn" class="save-btn" aria-label="Guardar selecciÃ³n">âœ”</button>
        </form>

        <div class="saved-wrap" aria-live="polite">
            <table id="savedTable" class="saved" aria-label="Selecciones guardadas">
                <thead>
                    <tr>
                        <th>Series</th>
                        <th>Repeticiones</th>
                        <th>Peso</th>
                        <th>Fecha</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="emptyMsg" class="empty-msg" style="display:none">No hay selecciones guardadas</div>
        </div>
    </div>

    <footer>Hecho por Carlos ðŸ’¥</footer>

    <script>
        // ========== CONFIGURACIÃ“N FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAi9mRo1r8z_aibkX4YaqIueXjmUXNgvKs",
            authDomain: "rutina-gym-76964.firebaseapp.com",
            databaseURL: "https://rutina-gym-76964-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "rutina-gym-76964",
            storageBucket: "rutina-gym-76964.firebasestorage.app",
            messagingSenderId: "684811073671",
            appId: "1:684811073671:web:5f1454c20825a090e3e022"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ========== RESTA DEL CÃ“DIGO ==========
        function getQueryParam(name) {
            const params = new URLSearchParams(location.search);
            return params.get(name);
        }

        const defaultImg = 'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Incline-Barbell-Bench-Press_dc0c6279-d038-44f5-a682-54c2a5e2602c_600x600.png?v=1612137944';
        const mainSrc = getQueryParam('img') ? decodeURIComponent(getQueryParam('img')) : defaultImg;

        const bigImage = document.getElementById('bigImage');
        bigImage.src = mainSrc;

        // ========== GESTIÃ“N CON FIREBASE ==========
        function getUserId() {
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('user_id', userId);
                console.log('Nuevo usuario creado:', userId);
            }
            return userId;
        }

        const USER_ID = getUserId();

        // Cargar datos desde Firebase
        async function loadEntries() {
            try {
                console.log('Cargando datos de Firebase...');
                const snapshot = await db.ref('apuntes/' + USER_ID).once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    console.log('Datos encontrados en Firebase:', data);
                    return data.entries || [];
                } else {
                    console.log('No hay datos en Firebase, creando nodo vacÃ­o...');
                    await db.ref('apuntes/' + USER_ID).set({ entries: [] });
                    return [];
                }
            } catch (error) {
                console.error('Error cargando datos de Firebase:', error);
                try {
                    const localData = localStorage.getItem('apuntes_backup');
                    return localData ? JSON.parse(localData) : [];
                } catch (e) {
                    return [];
                }
            }
        }

        // Guardar datos en Firebase
        async function saveEntries(entries) {
            try {
                console.log('Guardando en Firebase:', entries);
                await db.ref('apuntes/' + USER_ID).set({ entries });
                localStorage.setItem('apuntes_backup', JSON.stringify(entries));
                console.log('Datos guardados correctamente en Firebase');
            } catch (error) {
                console.error('Error guardando en Firebase:', error);
                localStorage.setItem('apuntes_backup', JSON.stringify(entries));
            }
        }

        async function renderTable() {
            const tbody = document.querySelector('#savedTable tbody');
            const emptyMsg = document.getElementById('emptyMsg');
            
            tbody.innerHTML = '<tr><td colspan="5">Cargando...</td></tr>';
            
            const entries = await loadEntries();
            
            tbody.innerHTML = '';
            if (!entries.length) {
                document.getElementById('savedTable').style.display = 'none';
                emptyMsg.style.display = 'block';
                return;
            }
            
            document.getElementById('savedTable').style.display = '';
            emptyMsg.style.display = 'none';
            
            entries.forEach((e, idx) => {
                const tr = document.createElement('tr');
                const tdS = document.createElement('td');
                tdS.textContent = e.series || '-';
                const tdR = document.createElement('td');
                tdR.textContent = e.reps || '-';
                const tdP = document.createElement('td');
                tdP.textContent = e.peso || '-';
                const tdT = document.createElement('td');
                tdT.textContent = new Date(e.t).toLocaleString();
                
                tr.appendChild(tdS);
                tr.appendChild(tdR);
                tr.appendChild(tdP);
                tr.appendChild(tdT);
                
                const tdDel = document.createElement('td');
                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'del-btn';
                delBtn.setAttribute('aria-label', 'Borrar entrada');
                delBtn.title = 'Borrar';
                delBtn.innerText = 'ðŸ—‘';
                delBtn.addEventListener('click', () => {
                    deleteEntry(idx);
                });
                tdDel.appendChild(delBtn);
                tr.appendChild(tdDel);
                
                tbody.appendChild(tr);
            });
        }

        async function deleteEntry(index) {
            const entries = await loadEntries();
            if (index < 0 || index >= entries.length) return;
            entries.splice(index, 1);
            await saveEntries(entries);
            await renderTable();
        }

        // guardar la selecciÃ³n actual
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const seriesSel = document.getElementById('seriesSelect');
            const repsSel = document.getElementById('option2');
            const pesoSel = document.getElementById('option3');
            const entry = {
                series: seriesSel.options[seriesSel.selectedIndex]?.text || '',
                reps: repsSel.options[repsSel.selectedIndex]?.text || '',
                peso: pesoSel.options[pesoSel.selectedIndex]?.text || '',
                t: Date.now()
            };
            
            const entries = await loadEntries();
            entries.push(entry);
            await saveEntries(entries);
            await renderTable();
            
            document.getElementById('saveBtn').animate([{ transform: 'scale(1.05)' }, { transform: 'scale(1)' }], { duration: 150 });
        });

        // funciÃ³n genÃ©rica para aÃ±adir opciones a un select desde un prompt
        function attachAddButton(buttonId, selectId, promptText) {
            const btn = document.getElementById(buttonId);
            const select = document.getElementById(selectId);
            if (!btn || !select) return;
            btn.addEventListener('click', () => {
                const input = prompt(promptText);
                if (!input) return;
                const label = input.trim();
                if (!label) return;
                const existing = Array.from(select.options).find(opt => opt.text.toLowerCase() === label.toLowerCase());
                if (existing) {
                    existing.selected = true;
                    return;
                }
                let base = label.replace(/\s+/g, '_').replace(/[^\w\-]/g, '');
                let candidate = base || ('opt' + Date.now());
                let i = 1;
                while (Array.from(select.options).some(o => o.value === candidate)) {
                    candidate = base + '_' + (i++);
                }
                const opt = document.createElement('option');
                opt.value = candidate;
                opt.text = label;
                select.appendChild(opt);
                opt.selected = true;
            });
        }

        attachAddButton('addSeriesBtn', 'seriesSelect', 'Introduce nueva opciÃ³n de Series (ej: 5Âº Serie):');
        attachAddButton('addOption2Btn', 'option2', 'Introduce nueva opciÃ³n de Repeticiones (ej: 14):');
        attachAddButton('addOption3Btn', 'option3', 'Introduce nuevo Peso (ej: 20):');

        // render inicial
        renderTable();
    </script>
</body>
</html>

